<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.9.1/css/bulma.min.css">
    <script defer src="https://use.fontawesome.com/releases/v5.14.0/js/all.js"></script>
    <link rel="stylesheet" href="style.css">

</head>

<body>
    
    <iframe id="previewWidget"></iframe>
    
    <section class="section">
        <div class="container">
            <div class="box is-small">
                <div class="content">
                    <ol id="instructions"></ol>
                </div>
            </div>    
        </div>
    </section>
    
    <div id="graphContainer" style="width: 50%"></div>

    <section class="section">
        <div class="columns is-8">
            <div class="column is-one-third is-offset-2" id="progressBadNutr"></div>
            <div class="column is-one-third " id="progressGoodNutr"></div>
        </div>
    </section>

    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@0.7.0"></script>
    <script>

        $(document).ready(function () {

            // get recipeId from localStorage
            var recipeId = localStorage.getItem("recipeId");

            var key = '18fae4ffca624ea6872a5d0b9787476e';

            getIngredients(recipeId);
            getNutrients(recipeId);

            // function to get recipe ingredients
            function getIngredients(recipeId) {
                // URL for detailed ingredients
                var ingredId = recipeId;
                // visualize nutrition query url 
                var ingVisualizerUrl = `https://api.spoonacular.com/recipes/visualizeIngredients?apiKey=${key}`;
                // ingredients list query url
                var ingQueryUrl = `https://api.spoonacular.com/recipes/${ingredId}/information?apiKey=${key}`;

                // ajax call to get ingredients
                $.ajax({
                    url: ingQueryUrl,
                    method: "GET"
                }).then(function (response) {
                    // console.log(response);
                    let steps = response.analyzedInstructions[0].steps;
                    for (var i = 0; i < steps.length; i++) {
                        var currentStep = steps[i].step;
                        var lineItem = '<li>' + currentStep + '</li>';
                        $("#instructions").append(lineItem);
                        $("#instructions").append('<hr>')
                    }

                    // declare variable that holds all ingredients information
                    var allIngr = '';
                    var servings = response.servings;
                    var measure = 'us';
                    var viewStyle = 'grid';
                    var ingreds = response.extendedIngredients;
                    var time = response.readyInMinutes;

                    // for loop to loop through all items in response.extendedIngredients
                    for (var i=0, j=ingreds.length; i<j; i++) {
                        // combine ingredients into one string
                        allIngr += (ingreds[i].originalString+'\n');
                    }

                    previewIngredientWidget(ingVisualizerUrl, servings, measure, viewStyle, allIngr);
                })
            }

            function previewIngredientWidget(ingVisualizerUrl,servings, measure, viewStyle, ingredients) {

                var xmlHttp = new XMLHttpRequest();
                xmlHttp.onreadystatechange = function() {
                    if (xmlHttp.readyState == 4 && xmlHttp.status == 200) {
                        previewIngredientWidgetCallback(xmlHttp.responseText);
                    }
                }

                xmlHttp.open("POST", ingVisualizerUrl, true);
                xmlHttp.send('defaultCss=true&servings='+servings+'&view='+viewStyle+'&measure='+measure+'&ingredientList='+ingredients);
            }

            function previewIngredientWidgetCallback(response) {
                console.log(response);

                var iframeDoc = $("#previewWidget")[0].contentWindow.document;
                console.log(response);
                iframeDoc.open();
                iframeDoc.write(response);
                iframeDoc.close();

                var scriptEl = $("<script>", {
                    type: "text/javascript",
                    src: "https://code.jquery.com/jquery-3.4.1.min.js"
                });
                var myFrameHead = $("#previewWidget").contents().find('head');

                myFrameHead.append(scriptEl);

                setTimeout(function () {
                    var scriptElTwo = $("<script>", {
                        type: "text/javascript",
                        src: "https://spoonacular.com/application/frontend/js/ingredientWidget.min.js?c=1"
                    })

                    var myFrameBody = $("#previewWidget").contents().find('body');
                    myFrameBody.append(scriptElTwo);
                }, 1000);
            }

            // function to get nutrients
            function getNutrients(recipeId) {
                // URL for recipe nutrition
                var nutrId = recipeId;
                var nutrQueryUrl = `https://api.spoonacular.com/recipes/${nutrId}/nutritionWidget.json?apiKey=${key}`

                // ajax call to get nutrients
                $.ajax({
                    url: nutrQueryUrl,
                    get: "GET"
                }).then(function (response) {

                    // declare objects to store detailed nutrition facts
                    var nutrientsBad = {};
                    var nutrientsGood = {};

                    // store overview facts in object. should this be displayed alongside recipe display?
                    // var quickNutrFacts = {
                    //     calories: response.calories,
                    //     carbs: response.carbs,
                    //     fat: response.fat,
                    //     protein: response.protein
                    // }

                    // store nutrition fact objects in objects
                    var badNutr = response.bad.length;
                    for (var i = 0; i < badNutr; i++) {
                        nutrientsBad[response.bad[i].title] = response.bad[i];
                    }

                    // store nutrition fact objects in objects
                    var goodNutr = response.good.length;
                    for (var i = 0; i < goodNutr; i++) {
                        nutrientsGood[response.good[i].title] = response.good[i];
                    }

                    // loop through bad nutrients and create progress bars
                    $.each(nutrientsBad, function (key) {
                        var percentages = nutrientsBad[key].percentOfDailyNeeds;
                        var newDiv = $("<div>", {"class": "container"});
                        var newSpan = $("<span>", {text: `${percentages}%`});
                        var newProgress = $("<progress>", 
                            {"class": "progress is-danger",
                            value: percentages,
                            max: '100'});
                        
                        newDiv.append(newSpan, newProgress);
                        newDiv.append($("<br>"));
                        $("#progressBadNutr").append(newDiv);
                    })

                    // loop through good nutrients and create progress bars
                    $.each(nutrientsGood, function (key) {
                        var percentages = nutrientsGood[key].percentOfDailyNeeds;
                        var newDiv = $("<div>", {"class": "container"});
                        var newSpan = $("<span>", {text: `${percentages}%`});
                        var newProgress = $("<progress>", 
                            {"class": "progress is-info",
                            value: percentages,
                            max: '100'});
                        
                        newDiv.append(newSpan, newProgress);
                        newDiv.append($("<br>"));
                        $("#progressGoodNutr").append(newDiv);
                    })

                    $("#graphContainer").append(newCanvBad, newCanvGood);
                    console.log(badPerc, goodPerc)

                })
            }
        });



    </script>
</body>

</html>